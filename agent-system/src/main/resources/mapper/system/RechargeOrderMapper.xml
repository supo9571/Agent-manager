<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.manager.system.mapper.RechargeOrderMapper">

    <select id="getRechargeOrderList" parameterType="com.manager.common.core.domain.entity.RechargeOrder"
            resultType="com.manager.common.core.domain.entity.RechargeOrder">
        SELECT
            cro.id as id,
            cro.order_number as orderNumber,
            cro.third_party_order_number as thirdPartyOrderNumber,
            cro.uid as uid,
            (SELECT dr.name from data_register dr where dr.uid = cro.uid LIMIT 1) as uname,
            cro.before_order_money as beforeOrderMoney,
            cro.after_order_money as afterOrderMoney,
            cro.recharge_amount as rechargeAmount,
            (
            select
                <choose>
                    <when test="monthlyCardType != null and monthlyCardType !='1'">
                        cmr.jin_recharge_give as rechargeGive
                    </when>
                    <otherwise>
                        cmr.yin_recharge_give as rechargeGive
                    </otherwise>
                </choose>
            from
            config_month_recharge cmr
            where
            cmr.status = '1'
            and (cmr.yin_recharge_give = cro.recharge_amount or cmr.jin_recharge_give = cro.recharge_amount)
            limit 0,1
            ) as standAmount,
            cro.recharge_type as rechargeType,
            cro.recharge_channel as rechargeChannel,
            cro.payment_status as paymentStatus,
            (SELECT dr.channel from data_register dr where dr.uid = cro.uid LIMIT 1) as channel,
            cro.admin_user_id as adminUserId,
            cro.reality_name as realityName,
            cro.ex_coins as exCoins,
            cro.finish_time as finishTime,
            cro.create_time as createTime,
            cro.update_time as updateTime,
            cro.commodity_name as commodityName,
            cro.transfer_way as transferWay,
            cro.remark as remark
        FROM
            config_recharge_order cro
        where 1 = 1
        <if test="uid !=null and uid !=''">
            and cro.uid = #{uid}
        </if>
        <if test="orderNumber !=null and orderNumber !=''">
            and cro.order_number = #{orderNumber}
        </if>
        <if test="thirdPartyOrderNumber !=null and thirdPartyOrderNumber !=''">
            and cro.third_party_order_number = #{thirdPartyOrderNumber}
        </if>
        <if test="channel !=null and channel !=''">
            and (SELECT dr.channel from data_register dr where dr.uid = cro.uid) = #{channel}
        </if>
        <if test="adminUserId !=null and adminUserId !=''">
            and cro.admin_user_id = #{adminUserId}
        </if>
        <if test="realityName !=null and realityName !=''">
            and cro.reality_name = #{realityName}
        </if>
        <if test="rechargeType !=null and rechargeType !=''">
            and cro.recharge_type in
            <foreach item="item" index="index" collection="rechargeType.split(',')" open="(" separator="," close=")">
                '${item}'
            </foreach>
        </if>
        <if test="rechargeChannel !=null and rechargeChannel !=''">
            and cro.recharge_channel = #{rechargeChannel}
        </if>
        <if test="paymentStatus !=null and paymentStatus !=''">
            and cro.payment_status = #{paymentStatus}
        </if>
        <if test="rechargeAmount !=null">
            and cro.recharge_amount = #{rechargeAmount}
        </if>

        <if test="createTime1 !=null and createTime1 !=''">
            and date_format(cro.create_time,'%Y-%m-%d') >= #{createTime1}
        </if>
        <if test="finishTime2 !=null and finishTime2 !=''">
            and date_format(cro.create_time,'%Y-%m-%d') <![CDATA[<=]]>  #{finishTime2}
        </if>

        <if test="finishTime1 !=null and finishTime1 !=''">
            and date_format(cro.finish_time,'%Y-%m-%d') >= #{finishTime1}
        </if>
        <if test="finishTime2 !=null and finishTime2 !=''">
            and date_format(cro.finish_time,'%Y-%m-%d') <![CDATA[<=]]>  #{finishTime2}
        </if>
    </select>

    <insert id="addRechargeOrder" parameterType="com.manager.common.core.domain.entity.RechargeOrder">
        insert into
            config_recharge_order(
            tid,
            order_number,
            uid,
            commodity_name,
            recharge_amount,
            recharge_type,
            recharge_channel,
            payment_status,
            create_time,
            finish_time,
            remark,
            before_order_money,after_order_money,admin_user_id,ex_coins
        )
        values (
            #{tid},
            #{orderNumber},
            #{uid},
            #{commodityName},
            #{rechargeAmount},
            #{rechargeType},
            #{rechargeChannel},
            '1',
            sysdate(),
            sysdate(),
            #{remark},
            #{beforeOrderMoney},#{afterOrderMoney},#{adminUserId},#{exCoins}
       )
    </insert>

    <update id="editRechargeOrder" parameterType="com.manager.common.core.domain.entity.RechargeOrder">
        update config_recharge_order cro
        <set>
            <if test="rechargeAmount !=null">
                and cro.recharge_amount = #{rechargeAmount}
            </if>
            <if test="beforeOrderMoney !=null">
                and cro.before_order_money = #{beforeOrderMoney}
            </if>
            <if test="afterOrderMoney !=null">
                and cro.after_order_money = #{afterOrderMoney}
            </if>
            <if test="adminUserId !=null">
                and cro.admin_user_id = #{adminUserId}
            </if>
            <if test="exCoins !=null">
                and cro.ex_coins = #{exCoins}
            </if>
            <if test="paymentStatus !=null">
                and cro.payment_status = #{paymentStatus}
            </if>
            <if test="thirdPartyOrderNumber!=null and thirdPartyOrderNumber!=''">
                and cro.third_party_order_number = #{thirdPartyOrderNumber},
            </if>
            <if test="remark!=null and remark!=''">
                remark = #{remark},
            </if>
            update_time = sysdate()
        </set>
        where id = #{id} and tid=#{tid}
    </update>

    <select id="getRechargeAmount" resultType="java.util.Map">
        select
            <choose>
                <when test="monthlyCardType != null and monthlyCardType !='1'">
                    jin_recharge as recharge,
                    jin_recharge_give as rechargeGive
                </when>
                <otherwise>
                    yin_recharge as recharge,
                    yin_recharge_give as rechargeGive
                </otherwise>
            </choose>
        from
            config_month_recharge
        where
            status = '1' limit 0,1
    </select>


</mapper>
